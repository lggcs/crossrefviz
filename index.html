<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Cross-Reference Visualization</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìñ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        #viz-container {
            position: relative;
        }
        canvas {
            position: absolute;
            top: -37vh;  /* Hide 37% of canvas behind the header */
            left: 0;
        }
        .tooltip {
            position: fixed;
            background: rgba(17, 24, 39, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .sidebar-book {
            transition: background-color 0.15s;
        }
        .sidebar-book:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .sidebar-book.active {
            background-color: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
        }

        /* Responsive Sidebar - drawer on mobile, static on desktop */
        .responsive-sidebar {
            width: 16rem;
            background-color: #1f2937;
            border-right: 1px solid #374151;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        @media (min-width: 640px) {
            .responsive-sidebar {
                width: 18rem;
            }
        }
        @media (max-width: 640px) {
            .responsive-sidebar {
                display: none;
            }
            .responsive-sidebar.open {
                display: flex;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 85%;
                max-width: 320px;
                z-index: 50;
                animation: slideInLeft 0.3s ease;
                border-right: 0;
            }
        }

        /* Responsive Details Panel - drawer on mobile, static on desktop */
        .responsive-details {
            width: 18rem;
            background-color: #1f2937;
            border-left: 1px solid #374151;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        @media (min-width: 640px) {
            /* Desktop - details panel is always visible */
        }
        @media (max-width: 640px) {
            .responsive-details {
                display: none;
            }
            .responsive-details.open {
                display: flex;
                position: fixed;
                right: 0;
                bottom: 0;
                left: 0;
                top: auto;
                max-height: 85vh;
                z-index: 50;
                border-left: 0;
                animation: slideUp 0.3s ease;
            }
        }

        /* Animations */
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        /* Overlay for mobile drawers */
        .drawer-overlay {
            display: none;
        }
        @media (max-width: 640px) {
            .drawer-overlay.show {
                display: block;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }
        }

        /* Mobile header */
        .mobile-only {
            display: none !important;
        }
        @media (max-width: 640px) {
            .mobile-only {
                display: flex !important;
            }
            .desktop-only {
                display: none !important;
            }
        }

        .mobile-fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        .mobile-fab:hover {
            transform: scale(1.05);
            background: #2563eb;
        }
        .mobile-fab:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col">
    <!-- Overlay for mobile drawers -->
    <div id="drawer-overlay" class="drawer-overlay"></div>

    <!-- Mobile FAB buttons -->
    <div class="mobile-only fixed bottom-20 right-4 z-30 flex flex-col gap-3">
        <button id="menu-toggle" class="mobile-fab" title="Open menu">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <button id="details-toggle" class="mobile-fab hidden" title="View details">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        </button>
    </div>

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 px-3 py-2 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center gap-2">
            <h1 class="text-base sm:text-lg font-bold text-blue-400 truncate">Bible Cross-References</h1>
            <span class="text-xs text-gray-400 hidden sm:inline">
                <span id="stats">Loading...</span>
            </span>
        </div>
        <div class="flex items-center gap-2 sm:gap-4">
            <div class="hidden sm:flex items-center gap-1 sm:gap-2">
                <label class="text-xs text-gray-400">Votes:</label>
                <input type="range" id="vote-threshold" min="1" max="50" value="5"
                       class="w-20 sm:w-24 h-2 bg-gray-700 rounded-lg cursor-pointer">
                <span id="vote-value" class="text-xs w-6">5</span>
            </div>
            <div class="hidden sm:flex items-center gap-1 sm:gap-2">
                <label class="text-xs text-gray-400">Arcs:</label>
                <input type="range" id="arc-limit" min="100" max="3000" value="500" step="100"
                       class="w-20 sm:w-24 h-2 bg-gray-700 rounded-lg cursor-pointer">
                <span id="arc-value" class="text-xs w-8">500</span>
            </div>
            <input type="text" id="search-input" placeholder="Search (e.g., John 3:16, Gen 1:1-3)... "
                   class="bg-gray-700 text-gray-100 text-xs rounded px-2 py-1 w-24 sm:w-48 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="toggleHelp()" class="text-gray-400 hover:text-blue-300 transition-colors" title="Help">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </button>
        </div>
    </header>

    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden" onclick="if(event.target===this) toggleHelp()">
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-2xl max-w-md w-full mx-4 max-h-[85vh] overflow-y-auto">
            <div class="sticky top-0 bg-gray-800 border-b border-gray-700 px-4 py-3 flex items-center justify-between">
                <h2 class="text-sm font-semibold text-blue-400">How to Use</h2>
                <button onclick="toggleHelp()" class="text-gray-400 hover:text-white">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="px-4 py-4 space-y-4 text-xs text-gray-300">
                <div>
                    <h3 class="font-semibold text-gray-100 mb-1">What You're Viewing</h3>
                    <p class="leading-relaxed">Thousands of Bible cross-references mapped to Rainbow-colored themes. Each arc shows a connection between two verses, colored by the dominant theme of the source verse.</p>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-100 mb-1">Navigate Visualization</h3>
                    <ul class="space-y-1 ml-4 list-disc">
                        <li><strong>Horizontally scroll</strong> to move through chapters</li>
                        <li><strong>Click an arc</strong> to select a cross-reference</li>
                        <li><strong>Use arrow buttons</strong> on canvas to step through arcs</li>
                        <li><strong>Use keyboard arrows</strong> ‚Üê ‚Üí for quick navigation</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-100 mb-1">View Details</h3>
                    <ul class="space-y-1 ml-4 list-disc">
                        <li><strong>Selected ARC</strong> shows in details panel with source/target verse text</li>
                        <li><strong>Click a book</strong> in left sidebar to filter to its references</li>
                        <li><strong>Bible Difficulties</strong> appear below arcs when scrolled</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-100 mb-1">Rainbow Themes</h3>
                    <p class="leading-relaxed">Each color represents a theological theme (e.g., God=blue, Creation=green, Redemption=purple). Filter by theme using the sidebar.</p>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-100 mb-1">Controls</h3>
                    <ul class="space-y-1 ml-4 list-disc">
                        <li><strong>Votes slider</strong> ‚Äî filter cross-references by community votes</li>
                        <li><strong>Arcs slider</strong> ‚Äî limit number of visible arcs</li>
                        <li><strong>Search</strong> ‚Äî find books (e.g., "Genesis") or verses (e.g., "John 3:16", "Gen 1:1-3")</li>
                        <li><strong>Verse search</strong> ‚Äî finds verse + all connected cross-references (shows relevant arcs only)</li>
                        <li><strong>Source filters</strong> ‚Äî toggle Bible difficulties by source</li>
                    </ul>
                </div>

                <div class="pt-2 border-t border-gray-700">
                    <p class="text-gray-500 italic">Use the <kbd class="bg-gray-700 px-1.5 py-0.5 rounded text-[10px]">?</kbd> button to show/hide this help</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Controls Bar -->
    <div class="mobile-only bg-gray-800 border-b border-gray-700 px-3 py-2 flex items-center gap-3 flex-shrink-0">
        <div class="flex items-center gap-1">
            <label class="text-xs text-gray-400">Votes:</label>
            <input type="range" id="vote-threshold-mobile" min="1" max="50" value="5"
                   class="w-16 h-2 bg-gray-700 rounded-lg cursor-pointer">
            <span id="vote-value-mobile" class="text-xs w-5">5</span>
        </div>
        <div class="flex items-center gap-1">
            <label class="text-xs text-gray-400">Arcs:</label>
            <input type="range" id="arc-limit-mobile" min="100" max="3000" value="500" step="100"
                   class="w-16 h-2 bg-gray-700 rounded-lg cursor-pointer">
            <span id="arc-value-mobile" class="text-xs w-6">500</span>
        </div>
    </div>

    <!-- Main -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="responsive-sidebar">
            <div class="p-2 border-b border-gray-700 flex items-center justify-between">
                <h2 class="text-xs font-semibold text-gray-400 uppercase">Menu</h2>
                <button id="sidebar-close" class="mobile-only text-gray-400 hover:text-white p-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="p-2 border-b border-gray-700">
                <h2 class="text-xs font-semibold text-gray-400 uppercase">Themes</h2>
            </div>
            <div id="theme-filter" class="p-1 space-y-0.5 text-xs flex-1 overflow-y-auto">
                <!-- Populated by JS -->
            </div>
            <div class="p-2 border-b border-gray-700 border-t">
                <h2 class="text-xs font-semibold text-gray-400 uppercase">Books</h2>
            </div>
            <div id="book-list" class="p-1 space-y-0.5 text-xs flex-1 overflow-y-auto">
                <!-- Populated by JS -->
            </div>
        </aside>

        <!-- Visualization -->
        <main class="flex-1 flex flex-col bg-gray-900 overflow-hidden">
            <div id="viz-container" class="relative overflow-x-auto overflow-y-hidden" style="flex: 1; min-width: 0;">
                <canvas id="main-canvas"></canvas>
                <!-- Navigation arrows for arcs -->
                <button id="nav-left-arc" class="absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-gray-800/90 hover:bg-gray-700 border border-gray-600 rounded-full flex items-center justify-center text-gray-300 transition-all z-10 hover:scale-110 active:scale-95 hidden">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <button id="nav-right-arc" class="absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-gray-800/90 hover:bg-gray-700 border border-gray-600 rounded-full flex items-center justify-center text-gray-300 transition-all z-10 hover:scale-110 active:scale-95 hidden">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
                <div id="status-bar-overlay" class="absolute left-0 right-0 bg-gray-800 border-t border-gray-700 px-3 h-8 flex items-center text-xs text-gray-400 z-10 hidden" style="height: 32px;">
                    Hover over the visualization to explore
                </div>
                <div id="bible-diff-overlay" class="absolute left-0 right-0 border-t border-gray-700 bg-gray-800/50 z-10 hidden" style="overflow-y: auto;">
                    <div class="px-2 sm:px-3 py-2 flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-0 sm:justify-between">
                        <div class="flex items-center gap-2">
                            <h3 class="text-xs font-semibold text-gray-400 uppercase">Bible Difficulties</h3>
                            <span id="bible-diff-filter-label" class="text-xs text-blue-400 hidden">(<span id="bible-diff-book-label">Book</span>)</span>
                        </div>
                        <div class="flex items-center gap-2 sm:gap-3">
                            <div class="flex items-center gap-2 text-[10px] text-gray-500">
                                <div class="flex items-center gap-1 cursor-pointer opacity-100 transition-opacity hover:opacity-80"
                                     data-source-filter="defendinginerrancy.com" onclick="toggleSourceFilter('defendinginerrancy.com', this)">
                                    <span id="filter-dot-defending" class="w-2 h-2 rounded-full bg-green-400"></span>
                                    <span class="hidden sm:inline">defending</span>
                                </div>
                                <div class="flex items-center gap-1 cursor-pointer opacity-100 transition-opacity hover:opacity-80"
                                     data-source-filter="kjvtoday.net" onclick="toggleSourceFilter('kjvtoday.net', this)">
                                    <span id="filter-dot-kjvtoday" class="w-2 h-2 rounded-full bg-yellow-400"></span>
                                    <span class="hidden sm:inline">kjvtoday</span>
                                </div>
                                <div class="flex items-center gap-1 cursor-pointer opacity-100 transition-opacity hover:opacity-80"
                                     data-source-filter="answersingenesis.org" onclick="toggleSourceFilter('answersingenesis.org', this)">
                                    <span id="filter-dot-aig" class="w-2 h-2 rounded-full bg-blue-400"></span>
                                    <span class="hidden sm:inline">aig</span>
                                </div>
                                <div class="flex items-center gap-1 cursor-pointer opacity-100 transition-opacity hover:opacity-80"
                                     data-source-filter="christcreated.com" onclick="toggleSourceFilter('christcreated.com', this)">
                                    <span id="filter-dot-christcreated" class="w-2 h-2 rounded-full bg-purple-400"></span>
                                    <span class="hidden sm:inline">christcreated</span>
                                </div>
                                <div class="flex items-center gap-1 cursor-pointer opacity-100 transition-opacity hover:opacity-80"
                                     data-source-filter="lighthousetrailsresearch.com" onclick="toggleSourceFilter('lighthousetrailsresearch.com', this)">
                                    <span id="filter-dot-lighthouse" class="w-2 h-2 rounded-full bg-orange-400"></span>
                                    <span class="hidden sm:inline">lighthouse</span>
                                </div>
                            </div>
                            <input type="text" id="bible-diff-search-overlay" placeholder="Search..."
                                   class="bg-gray-700 text-gray-100 text-xs rounded px-2 py-1 flex-1 sm:w-32 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div id="bible-diff-list-overlay" class="px-2 sm:px-3 pb-3 text-xs space-y-1">
                        <p class="text-gray-500 text-center py-2">Loading Bible difficulties...</p>
                    </div>
                </div>
            </div>
            <div id="status-bar" class="h-8 bg-gray-800 border-t border-gray-700 px-3 flex items-center text-xs text-gray-400 hidden">
                Hover over the visualization to explore
            </div>

            <!-- Bible Difficulties Section -->
            <div id="bible-diff-container" class="border-t border-gray-700 bg-gray-800/50 hidden">
                <div class="px-2 sm:px-3 py-2 flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-0 sm:justify-between">
                    <div class="flex items-center gap-2">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase">Bible Difficulties</h3>
                        <span id="bible-diff-filter-label-container" class="text-xs text-blue-400 hidden">(<span id="bible-diff-book-label-container">Book</span>)</span>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <div class="flex items-center gap-2 text-[10px] text-gray-500">
                            <div class="flex items-center gap-1 cursor-pointer opacity-100 transition-opacity hover:opacity-80"
                                 data-source-filter="defendinginerrancy.com" onclick="toggleSourceFilter('defendinginerrancy.com', this)">
                                <span id="filter-dot-defending-container" class="w-2 h-2 rounded-full bg-green-400"></span>
                                <span class="hidden sm:inline">defending</span>
                            </div>
                            <div class="flex items-center gap-1 cursor-pointer opacity-100 transition-opacity hover:opacity-80"
                                 data-source-filter="kjvtoday.net" onclick="toggleSourceFilter('kjvtoday.net', this)">
                                <span id="filter-dot-kjvtoday-container" class="w-2 h-2 rounded-full bg-yellow-400"></span>
                                <span class="hidden sm:inline">kjvtoday</span>
                            </div>
                            <div class="flex items-center gap-1 cursor-pointer opacity-100 transition-opacity hover:opacity-80"
                                 data-source-filter="answersingenesis.org" onclick="toggleSourceFilter('answersingenesis.org', this)">
                                <span id="filter-dot-aig-container" class="w-2 h-2 rounded-full bg-blue-400"></span>
                                <span class="hidden sm:inline">aig</span>
                            </div>
                            <div class="flex items-center gap-1 cursor-pointer opacity-100 transition-opacity hover:opacity-80"
                                 data-source-filter="christcreated.com" onclick="toggleSourceFilter('christcreated.com', this)">
                                <span id="filter-dot-christcreated-container" class="w-2 h-2 rounded-full bg-purple-400"></span>
                                <span class="hidden sm:inline">christcreated</span>
                            </div>
                            <div class="flex items-center gap-1 cursor-pointer opacity-100 transition-opacity hover:opacity-80"
                                 data-source-filter="lighthousetrailsresearch.com" onclick="toggleSourceFilter('lighthousetrailsresearch.com', this)">
                                <span id="filter-dot-lighthouse-container" class="w-2 h-2 rounded-full bg-orange-400"></span>
                                <span class="hidden sm:inline">lighthouse</span>
                            </div>
                        </div>
                        <input type="text" id="bible-diff-search-container" placeholder="Search..."
                               class="bg-gray-700 text-gray-100 text-xs rounded px-2 py-1 flex-1 sm:w-32 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div id="bible-diff-list-container" class="px-2 sm:px-3 pb-3 max-h-48 overflow-y-auto text-xs space-y-1">
                    <p class="text-gray-500 text-center py-2">Loading Bible difficulties...</p>
                </div>
            </div>

            <!-- Mobile footer -->
            <footer class="h-6 sm:h-6 flex bg-gray-800 border-t border-gray-700 px-3 items-center justify-center text-[10px] text-gray-500 flex-shrink-0">
                Cross-references from <a href="https://openbible.info/labs/cross-references/" class="text-blue-400 hover:text-blue-300" target="_blank">openbible.info</a> (CC BY 4.0) ‚Ä¢ KJV text from <a href="https://github.com/farskipper/kjv" class="text-blue-400 hover:text-blue-300" target="_blank">farskipper/kjv</a>
            </footer>
        </main>

        <!-- Detail Panel - Responsive (static on desktop, drawer on mobile) -->
        <aside id="details-panel" class="responsive-details">
            <div class="p-2 border-b border-gray-700 flex items-center justify-between">
                <h2 class="text-xs font-semibold text-gray-400 uppercase">Details</h2>
                <button id="details-close" class="mobile-only text-gray-400 hover:text-white p-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="detail-content" class="flex-1 overflow-y-auto p-2 text-xs">
                <p class="text-gray-500">Click on a chapter to see details</p>
            </div>
        </aside>
    </div>

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center w-64">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
            <p id="loading-text" class="text-gray-400 text-sm">Loading data...</p>
            <div id="loading-progress" class="w-full bg-gray-700 rounded-full h-2 mt-3 hidden">
                <div id="loading-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="loading-detail" class="text-gray-500 text-xs mt-2"></p>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip hidden"></div>

    <script>
        // Simple state
        let verseTexts = {};
        let crossRefs = {};
        let incomingRefs = {};  // Reverse index: target verse -> array of source verses
        let versePositions = {};
        let chapters = [];  // Global chapters array - populated by buildStructure()
        let verseFilteredBibleDifficulties = [];  // Bible difficulties filtered by verse search
        let activeBook = null;
        let voteThreshold = 5;
        let arcLimit = 500;
        let searchQuery = '';
        let searchVerseRefs = [];  // Array of verse references from search query
        let searchConnectedVerseRefs = new Set();  // ALL verses connected via search (source + target)
        let searchArcIds = new Set();  // Set of arc IDs matching search
        let isVerseSearch = false;  // Whether this is a verse search (vs book/chapter search)
        let hoveredArc = null;
        let mouseX = 0, mouseY = 0;
        let verseThemes = {};  // Rainbow Bible theme mapping

        // State
        let activeTheme = null;  // Filter by theme
        let selectedArc = null;  // Currently selected arc from click
        let currentChapterView = null;  // Currently displayed chapter in details panel

        // Arc navigation state
        let visibleArcsForNavigation = [];  // Current visible arcs
        let currentArcIndex = -1;  // Currently selected arc by navigation (or -1 for none)
        let currentArcId = null;  // ID of the currently selected arc

        // Canvas
        let canvas, ctx;
        let width, height;

        // Pre-aggregated chapter data
        let chapterData = []; // { book, chapter, index, x, refCount, refs: [{toIndex, votes}] }

        // Helper to normalize book names for verse lookup
        // BOOK_NAMES uses "Psalm" but verses-1769.json uses "Psalms"
        function normalizeBookNameForText(book) {
            // Handle Psalm/Psalms inconsistency
            if (book === 'Psalm') return 'Psalms';
            if (book === 'Psalms') return 'Psalm';
            return book;
        }

        // Helper to get verse text, handling book name normalization
        function getVerseText(ref) {
            // Try the reference as-is first
            if (verseTexts[ref]) return verseTexts[ref];
            // Try with normalized book name
            const parts = ref.split(' ');
            const book = parts[0];
            const rest = parts.slice(1).join(' ');
            const normalizedBook = normalizeBookNameForText(book);
            if (normalizedBook !== book) {
                const normalizedRef = `${normalizedBook} ${rest}`;
                return verseTexts[normalizedRef];
            }
            return null;
        }

        // Parse Bible reference into book, chapter, verse
        function parseBibleRef(ref) {
            // Handle formats like "Genesis 1:1", "1 Chronicles 10:14", etc.
            const match = ref.match(/^\s*(.+?)\s*(\d+):(\d+)\s*$/);
            if (match) {
                return {
                    book: match[1].trim(),
                    chapter: parseInt(match[2]),
                    verse: parseInt(match[3])
                };
            }
            return null;
        }

        // Convert book name to BibleHub format (e.g., "Psalm" -> "psalms", "1 Samuel" -> "1_samuel")
        function bookToBibleHubFormat(book) {
            // Normalize common book name variations
            let normalized = book.toLowerCase();

            // Psalm -> Psalms
            if (normalized === 'psalm') {
                normalized = 'psalms';
            }

            // Handle numbered books: "1 samuel" -> "1_samuel", "2 kings" -> "2_kings", etc.
            normalized = normalized.replace(/^(\d+)\s+/, '$1_');

            return normalized;
        }

        // Generate BibleHub URL for a reference
        function getBibleHubUrl(ref) {
            const parsed = parseBibleRef(ref);
            if (!parsed) return null;
            const book = bookToBibleHubFormat(parsed.book);
            return `https://biblehub.com/${book}/${parsed.chapter}-${parsed.verse}.htm`;
        }

        const BOOK_NAMES = [
            "Genesis", "Exodus", "Leviticus", "Numbers", "Deuteronomy", "Joshua", "Judges", "Ruth",
            "1 Samuel", "2 Samuel", "1 Kings", "2 Kings", "1 Chronicles", "2 Chronicles", "Ezra", "Nehemiah",
            "Esther", "Job", "Psalm", "Proverbs", "Ecclesiastes", "Song of Solomon", "Isaiah", "Jeremiah",
            "Lamentations", "Ezekiel", "Daniel", "Hosea", "Joel", "Amos", "Obadiah", "Jonah",
            "Micah", "Nahum", "Habakkuk", "Zephaniah", "Haggai", "Zechariah", "Malachi",
            "Matthew", "Mark", "Luke", "John", "Acts", "Romans", "1 Corinthians", "2 Corinthians",
            "Galatians", "Ephesians", "Philippians", "Colossians", "1 Thessalonians", "2 Thessalonians", "1 Timothy", "2 Timothy",
            "Titus", "Philemon", "Hebrews", "James", "1 Peter", "2 Peter", "1 John", "2 John",
            "3 John", "Jude", "Revelation"
        ];

        // Rainbow Bible theme colors (default - will be loaded from verse_themes.json)
        let RAINBOW_THEMES = {
            'God': { name: 'God', color: '#A020F0' },
            'Discipleship': { name: 'Discipleship', color: '#FA8072' },
            'Love': { name: 'Love', color: '#008000' },
            'Faith': { name: 'Faith', color: '#FFB347' },
            'Sin': { name: 'Sin', color: '#808080' },
            'Evil': { name: 'Evil', color: '#8B4513' },
            'Salvation': { name: 'Salvation', color: '#0000FF' },
            'Family': { name: 'Family', color: '#FFFF00' },
            'Outreach': { name: 'Outreach', color: '#FFC0CB' },
            'Commandments': { name: 'Commandments', color: '#808000' },
            'History': { name: 'History', color: '#C0C0C0' },
            'Prophecy': { name: 'Prophecy', color: '#FFD700' }
        };

        const THEME_ORDER = ['God', 'Discipleship', 'Love', 'Faith', 'Sin', 'Evil',
                           'Salvation', 'Family', 'Outreach', 'Commandments', 'History', 'Prophecy'];

        // Color interpolation for gradient arcs
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => {
                const hex = Math.round(x).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function lerpColor(color1, color2, t) {
            const rgb1 = hexToRgb(color1);
            const rgb2 = hexToRgb(color2);
            if (!rgb1 || !rgb2) return color1;

            return rgbToHex(
                rgb1.r + (rgb2.r - rgb1.r) * t,
                rgb1.g + (rgb2.g - rgb1.g) * t,
                rgb1.b + (rgb2.b - rgb1.b) * t
            );
        }

        // Update loading UI
        function updateLoading(text, progress, detail) {
            document.getElementById('loading-text').textContent = text;
            if (progress !== null) {
                const progressBar = document.getElementById('loading-progress');
                const loadingBar = document.getElementById('loading-bar');
                progressBar.classList.remove('hidden');
                loadingBar.style.width = progress + '%';
            }
            if (detail) {
                document.getElementById('loading-detail').textContent = detail;
            }
        }

        async function init() {
            canvas = document.getElementById('main-canvas');
            ctx = canvas.getContext('2d', { alpha: false });

            try {
                // Track loading progress
                const totalSteps = 5;
                let currentStep = 0;

                // Load data
                console.log('Loading verses...');
                updateLoading('Loading Bible verses...', (currentStep / totalSteps) * 100, 'Fetching verses-1769.json (~4.6MB)');
                const rv = await fetch('verses-1769.json');
                verseTexts = await rv.json();
                currentStep++;
                updateLoading('Loading Bible verses...', (currentStep / totalSteps) * 100, `${Object.keys(verseTexts).length.toLocaleString()} verses loaded`);

                console.log('Loading refs...');
                updateLoading('Loading cross-references...', (currentStep / totalSteps) * 100, 'Fetching openbible.json (~40MB) - this may take a moment');
                const rr = await fetch('openbible.json');
                const refsData = await rr.json();
                crossRefs = refsData.cross_references;

                // Build reverse index for incoming references (for efficient search)
                incomingRefs = {};
                for (const [source, refs] of Object.entries(crossRefs)) {
                    for (const ref of refs) {
                        if (!incomingRefs[ref.to]) {
                            incomingRefs[ref.to] = [];
                        }
                        incomingRefs[ref.to].push({source, votes: ref.votes});
                    }
                }

                currentStep++;
                updateLoading('Loading cross-references...', (currentStep / totalSteps) * 100, `${Object.values(crossRefs).reduce((a, b) => a + b.length, 0).toLocaleString()} references loaded`);

                console.log('Loading Rainbow Bible themes...');
                updateLoading('Loading themes...', ((currentStep) / totalSteps) * 100, 'Fetching verse_themes.json (~4.1MB)');
                const tr = await fetch('verse_themes.json');
                const themeData = await tr.json();
                verseThemes = themeData.verse_themes;
                currentStep++;
                updateLoading('Loading themes...', ((currentStep) / totalSteps) * 100, `${Object.keys(verseThemes).length.toLocaleString()} verse themes loaded`);

                // Load theme colors from JSON if available
                if (themeData.rainbow_themes) {
                    // Convert array format to object lookup
                    RAINBOW_THEMES = {};
                    themeData.rainbow_themes.forEach(t => {
                        RAINBOW_THEMES[t.name] = {name: t.name, color: t.color};
                    });
                    console.log('Loaded theme colors from JSON:', RAINBOW_THEMES);
                }

                // Load Bible difficulties from merged file
                console.log('Loading Bible difficulties...');
                updateLoading('Loading Bible difficulties...', ((currentStep) / totalSteps) * 100, 'Fetching bible_difficulties.json');

                try {
                    const bd = await fetch('bible_difficulties.json');
                    const rawData = await bd.json();

                    // Use bible_verse field for simpler mapping
                    window.bibleDifficulties = rawData;

                    console.log(`Loaded ${window.bibleDifficulties.length} articles from bible_difficulties.json`);
                } catch (e) {
                    console.warn('Could not load bible_difficulties.json:', e);
                    window.bibleDifficulties = [];
                }

                console.log(`Loaded ${window.bibleDifficulties.length} Bible difficulties`);

                console.log('Building structure...');
                updateLoading('Building data structure...', ((currentStep + 1) / totalSteps) * 100, 'Processing cross-references (this may take a moment)');
                await new Promise(resolve => setTimeout(resolve, 10));  // Allow UI to update
                buildStructure();

                // Update stats
                const totalVerses = Object.keys(verseTexts).length;
                const totalRefs = Object.values(crossRefs).reduce((a, b) => a + b.length, 0);
                document.getElementById('stats').textContent =
                    `${totalVerses.toLocaleString()} verses, ${totalRefs.toLocaleString()} refs`;

                console.log('Building UI...');
                updateLoading('Building UI...', ((currentStep + 1) / totalSteps) * 100, 'Rendering interface');
                
                // Build UI
                buildThemeFilter();
                buildBookList();
                buildBibleDifficultiesList();
                resize();
                setupEvents();
                
                document.getElementById('loading').style.display = 'none';
                render();
                
            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerHTML = 
                    `<p class="text-red-400">Error: ${e.message}</p>`;
            }
        }

        function getChapterTheme(book, chapter) {
            // Get theme from Rainbow Bible classification
            // Aggregate themes for all verses in this chapter
            let themeCounts = {};
            let v = 1;
            let totalVerses = 0;

            while (verseTexts[`${book} ${chapter}:${v}`]) {
                const verseRef = `${book} ${chapter}:${v}`;
                const theme = verseThemes[verseRef];
                if (theme && theme !== 'unknown') {
                    themeCounts[theme] = (themeCounts[theme] || 0) + 1;
                }
                totalVerses++;
                v++;
            }

            // Return dominant theme
            if (Object.keys(themeCounts).length === 0) {
                // Fallback to 'God' theme
                return RAINBOW_THEMES['God'];
            }

            const dominantTheme = Object.entries(themeCounts)
                .sort((a, b) => b[1] - a[1])[0][0];

            return RAINBOW_THEMES[dominantTheme] || RAINBOW_THEMES['God'];
        }

        function getVerseTheme(book, chapter, verse) {
            const verseRef = `${book} ${chapter}:${verse}`;
            const theme = verseThemes[verseRef];
            if (theme && theme !== 'unknown' && RAINBOW_THEMES[theme]) {
                return RAINBOW_THEMES[theme];
            }
            // Fallback to chapter theme
            return getChapterTheme(book, chapter);
        }

        function buildStructure() {
            console.time('buildStructure');

            // Filter cross-refs by minimum vote threshold for performance
            // This drastically reduces processing while keeping most important refs
            const MIN_VOTE_FOR_PROCESSING = 2;  // Only process refs with >= 2 votes
            const filteredCrossRefs = {};

            for (const [source, refs] of Object.entries(crossRefs)) {
                const highVoteRefs = refs.filter(r => r.votes >= MIN_VOTE_FOR_PROCESSING);
                if (highVoteRefs.length > 0) {
                    filteredCrossRefs[source] = highVoteRefs;
                }
            }
            console.log(`Filtered ${Object.values(crossRefs).reduce((a,b) => a+b.length, 0)} refs to ${Object.values(filteredCrossRefs).reduce((a,b) => a+b.length, 0)} (votes >= ${MIN_VOTE_FOR_PROCESSING})`);

            let verseIdx = 0;
            let chapterIdx = 0;

            // Build chapters array with themes and verse ranges
            for (const book of BOOK_NAMES) {
                const lookupBook = normalizeBookNameForText(book);  // Use normalized name for verse text lookup
                let ch = 1;
                while (true) {
                    const firstVerse = `${lookupBook} ${ch}:1`;
                    if (!verseTexts[firstVerse]) break;

                    let v = 1;
                    let chapterVerseCount = 0;
                    while (verseTexts[`${lookupBook} ${ch}:${v}`]) {
                        // Store verse position using BOOK_NAMES book ("Psalm")
                        const ref = `${book} ${ch}:${v}`;
                        versePositions[ref] = {
                            verseIdx,
                            chapterIdx,
                            verseIndex: v - 1,  // 0-based verse index in chapter
                            chapterVerseCount: null  // Will fill after loop
                        };
                        verseIdx++;
                        chapterVerseCount++;
                        v++;
                    }

                    // Update chapterVerseCount for all verses in this chapter
                    for (let i = 1; i <= chapterVerseCount; i++) {
                        versePositions[`${book} ${ch}:${i}`].chapterVerseCount = chapterVerseCount;
                    }

                    const theme = getChapterTheme(book, ch);
                    chapters.push({
                        book,
                        chapter: ch,
                        index: chapterIdx,
                        theme: theme,
                        verseCount: chapterVerseCount,
                        startVerseIndex: verseIdx - chapterVerseCount,
                        endVerseIndex: verseIdx
                    });
                    chapterIdx++;
                    ch++;
                }
            }

            // Build verse-level arcs (use filtered refs for performance)
            let verseArcs = [];

            for (const [source, refs] of Object.entries(filteredCrossRefs)) {
                // Normalize source reference
                const sourcePos = versePositions[source];
                if (!sourcePos) continue;

                for (const ref of refs) {
                    // Normalize target reference
                    const targetPos = versePositions[ref.to];
                    if (!targetPos) continue;

                    verseArcs.push({
                        sourcePos,
                        targetPos,
                        votes: ref.votes,
                        sourceChapter: chapters[sourcePos.chapterIdx],
                        targetChapter: chapters[targetPos.chapterIdx],
                        sourceRef: source,
                        targetRef: ref.to
                    });
                }
            }

            // Sort arcs by votes and limit to top N per chapter pair for performance
            // Group by chapter pairs
            const chapterPairArcs = {};
            for (const arc of verseArcs) {
                const key = `${arc.sourcePos.chapterIdx}-${arc.targetPos.chapterIdx}`;
                if (!chapterPairArcs[key]) {
                    chapterPairArcs[key] = [];
                }
                chapterPairArcs[key].push(arc);
            }

            // Keep top 5 arcs per chapter pair (highest voted)
            let filteredArcs = [];
            for (const [key, arcs] of Object.entries(chapterPairArcs)) {
                arcs.sort((a, b) => b.votes - a.votes);
                filteredArcs.push(...arcs.slice(0, 5));
            }

            // Sort all arcs globally by votes
            filteredArcs.sort((a, b) => b.votes - a.votes);
            window.verseArcs = filteredArcs;

            console.log(`Built ${filteredArcs.length} verse-level arcs from filtered refs`);

            // Aggregate cross-refs by chapter (use filtered refs for consistency)
            for (const [source, refs] of Object.entries(filteredCrossRefs)) {
                const pos = versePositions[source];
                if (!pos) continue;

                for (const ref of refs) {
                    const targetPos = versePositions[ref.to];
                    if (!targetPos) continue;

                    const chapter = chapters[pos.chapterIdx];
                    const targetCh = chapters[targetPos.chapterIdx];

                    if (!chapter.refs) {
                        chapter.refs = {};
                    }
                    const key = targetPos.chapterIdx;
                    if (!chapter.refs[key]) {
                        chapter.refs[key] = { votes: 0, count: 0, targetTheme: targetCh.theme };
                    }
                    chapter.refs[key].votes += ref.votes;
                    chapter.refs[key].count++;
                }
            }

            // Compute ref counts
            for (const ch of chapters) {
                ch.refCount = ch.refs ? Object.keys(ch.refs).length : 0;
                ch.refsArray = ch.refs ? Object.entries(ch.refs).map(([k, v]) => ({
                    toIndex: parseInt(k),
                    votes: v.votes,
                    count: v.count,
                    targetTheme: v.targetTheme
                })) : [];

                // Count refs at verse level for histogram
                ch.verseRefs = [];
                for (let v = 1; v <= ch.verseCount; v++) {
                    const ref = `${ch.book} ${ch.chapter}:${v}`;
                    const verseRefList = (crossRefs[ref] || []).filter(r => r.votes >= voteThreshold);
                    const verseTheme = getVerseTheme(ch.book, ch.chapter, v);
                    ch.verseRefs.push({
                        verseIndex: v,
                        refCount: verseRefList.length,
                        theme: verseTheme.color,
                        themeName: verseTheme.name
                    });
                }
            }

            console.timeEnd('buildStructure');

            // Make chapters globally accessible for navigation
            window.chapters = chapters;
        }

        function buildThemeFilter() {
            const container = document.getElementById('theme-filter');

            container.innerHTML = `
                <button onclick="setThemeFilter(null)"
                        class="w-full text-left px-2 py-1.5 rounded ${!activeTheme ? 'bg-gray-700 text-white' : 'text-gray-300 hover:bg-gray-700'}">
                    All Themes
                </button>
            `;

            for (const themeKey of THEME_ORDER) {
                const theme = RAINBOW_THEMES[themeKey];
                const isActive = activeTheme === themeKey;
                container.innerHTML += `
                    <button onclick="setThemeFilter('${themeKey}')"
                            class="w-full text-left px-2 py-1.5 rounded flex items-center gap-2 ${isActive ? 'bg-gray-700 text-white' : 'text-gray-300 hover:bg-gray-700'}">
                        <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${theme.color}"></span>
                        <span>${theme.name}</span>
                    </button>
                `;
            }
        }

        // Draw an arc with gradient: source color (0-70%) blending to target color (70-100%)
        function drawGradientArc(ctx, arc, opacity, isHovered) {
            const dx = Math.abs(arc.x2 - arc.x1);
            const lineWidth = isHovered ? 7 : Math.max(1, Math.min(3, arc.votes / 10));

            const midX = (arc.x1 + arc.x2) / 2;
            const curveHeight = Math.min(dx * 0.75, arc.height * 1.3);
            const ctrlY = arc.y - curveHeight;

            // Create gradient along the arc path
            const gradient = ctx.createLinearGradient(arc.x1, arc.y, arc.x2, arc.y);
            gradient.addColorStop(0, arc.sourceColor);  // Source color at start
            gradient.addColorStop(0.7, arc.sourceColor);  // Still source color at 70%
            gradient.addColorStop(1, arc.targetColor);  // Target color at end

            ctx.globalAlpha = opacity;

            if (isHovered) {
                ctx.shadowColor = arc.sourceColor;
                ctx.shadowBlur = 25;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }

            ctx.strokeStyle = gradient;
            ctx.lineWidth = lineWidth;
            ctx.beginPath();
            ctx.moveTo(arc.x1, arc.y);
            ctx.quadraticCurveTo(midX, ctrlY, arc.x2, arc.y);
            ctx.stroke();

            if (isHovered) {
                ctx.shadowBlur = 0;
            }

            ctx.globalAlpha = 1;
        }

        window.setThemeFilter = function(theme) {
            activeTheme = theme;
            buildThemeFilter();
            render();
        };

        function buildBookList() {
            const list = document.getElementById('book-list');
            list.innerHTML = '';

            const bookStarts = {};
            chapters.forEach(ch => {
                if (!bookStarts[ch.book]) {
                    bookStarts[ch.book] = { start: ch.index, end: ch.index, count: 0 };
                }
                bookStarts[ch.book].end = ch.index;
                bookStarts[ch.book].count++;
            });

            for (const book of BOOK_NAMES) {
                if (!bookStarts[book]) continue;
                const div = document.createElement('div');
                div.className = 'sidebar-book p-2.5 rounded cursor-pointer';
                div.dataset.book = book;
                div.innerHTML = `
                    <div class="font-medium truncate">${book}</div>
                    <div class="text-xs text-gray-400">${bookStarts[book].count} ch</div>
                `;
                div.addEventListener('click', () => {
                    selectBook(book);
                    // Close sidebar on mobile
                    if (window.innerWidth <= 640) {
                        document.getElementById('sidebar').classList.remove('open');
                        document.getElementById('drawer-overlay').classList.remove('show');
                    }
                });
                list.appendChild(div);
            }
        }

        // Source filter state
        let activeSourceFilters = new Set(); // Empty means all sources are shown

        // Map source names to short IDs for dot elements
        const sourceToShortId = {
            'defendinginerrancy.com': 'defending',
            'kjvtoday.net': 'kjvtoday',
            'answersingenesis.org': 'aig',
            'christcreated.com': 'christcreated',
            'lighthousetrailsresearch.com': 'lighthouse'
        };

        // Toggle source filter on/off
        function toggleSourceFilter(source, element) {
            if (activeSourceFilters.has(source)) {
                activeSourceFilters.delete(source);
                element.classList.remove('opacity-40');
                element.classList.add('opacity-100');
            } else {
                activeSourceFilters.add(source);
                element.classList.remove('opacity-100');
                element.classList.add('opacity-40');
            }

            // Update dot opacity in both overlay and container using the short ID mapping
            const shortId = sourceToShortId[source];
            if (shortId) {
                const dotIds = [`filter-dot-${shortId}`, `filter-dot-${shortId}-container`];
                dotIds.forEach(id => {
                    const dot = document.getElementById(id);
                    if (dot) {
                        if (activeSourceFilters.has(source)) {
                            dot.classList.add('opacity-30');
                        } else {
                            dot.classList.remove('opacity-30');
                        }
                    }
                });
            }

            // Re-render filter Bible difficulties list
            applySourceFilter();
        }

        // Apply source filter to the displayed articles
        function applySourceFilter() {
            if (!window.bibleDifficulties || window.bibleDifficulties.length === 0) return;

            let filtered = window.bibleDifficulties;

            // Filter by active source (exclude sources in the filter set)
            if (activeSourceFilters.size > 0) {
                filtered = filtered.filter(article => {
                    const source = article.source;
                    if (!source) return true; // Keep if no source
                    return !activeSourceFilters.has(source);
                });
            }

            // Filter by book if active
            if (activeBook) {
                const normalizedBook = activeBook === 'Psalm' ? 'Psalms' : activeBook;
                filtered = filtered.filter(article => {
                    const articleBook = extractBookFromArticle(article);
                    return articleBook.toLowerCase() === normalizedBook.toLowerCase();
                });
            }

            window.renderBibleDifficulties(filtered, true);
        }

        // Helper function to extract book name from Bible difficulty article
        // Uses pre-computed bible_verse field if available, falls back to title parsing
        function extractBookFromArticle(article) {
            // Use pre-computed bible_verse if available (simpler, more accurate)
            if (article.bible_verse) {
                // bible_verse can be a string or an array
                const verseRef = Array.isArray(article.bible_verse) ? article.bible_verse[0] : article.bible_verse;
                return String(verseRef).split(' ')[0];  // Just the book name part
            }

            // Fallback to title parsing if bible_verse not available
            const title = article.title || '';
            let book = 'Unknown';
            let match;

            // Try to find any book name at start of title
            match = title.match(/^([A-Z\d][A-Za-z\s]+?)\s+\d+:/);
            if (match) {
                book = match[1].trim();
            }

            // Normalize Psalm to Psalms
            if (book === 'Psalm') book = 'Psalms';

            return book;
        }

        function buildBibleDifficultiesList() {
            const container = document.getElementById('bible-diff-list');

            if (!window.bibleDifficulties || window.bibleDifficulties.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-2">No Bible difficulties loaded</p>';
                return;
            }

            // Display all articles (with source filters applied)
            applySourceFilter();

            // Setup search - sync between original and overlay inputs
            const bibleDiffSearchOverlay = document.getElementById('bible-diff-search-overlay');
            const bibleDiffSearchContainer = document.getElementById('bible-diff-search-container');

            const handleBibleDiffSearch = (e) => {
                const query = e.target.value.toLowerCase();

                // Sync values (only for elements that exist)
                [bibleDiffSearchOverlay, bibleDiffSearchContainer].forEach(el => {
                    if (el && el !== e.target) el.value = query;
                });

                // Start with verse-filtered results if available, otherwise use all
                let searchWithin = verseFilteredBibleDifficulties.length > 0
                    ? verseFilteredBibleDifficulties
                    : window.bibleDifficulties;

                // Apply source filter
                if (activeSourceFilters.size > 0) {
                    searchWithin = searchWithin.filter(article => !activeSourceFilters.has(article.source));
                }

                // Apply book filter (if not already filtered by verse search)
                if (activeBook && verseFilteredBibleDifficulties.length === 0) {
                    searchWithin = searchWithin.filter(article => {
                        const articleBook = extractBookFromArticle(article);
                        const normalizedBook = activeBook === 'Psalm' ? 'Psalms' : activeBook;
                        return articleBook.toLowerCase() === normalizedBook.toLowerCase();
                    });
                }

                // Search by title
                const filtered = searchWithin.filter(article =>
                    article.title.toLowerCase().includes(query)
                );
                window.renderBibleDifficulties(filtered, true); // Skip dedup since source is already filtered
            };

            bibleDiffSearchOverlay && (bibleDiffSearchOverlay.oninput = handleBibleDiffSearch);
            bibleDiffSearchContainer && (bibleDiffSearchContainer.oninput = handleBibleDiffSearch);
        }

        window.renderBibleDifficulties = function(articles, skipDedup = false) {
            const containers = [
                document.getElementById('bible-diff-list-overlay'),
                document.getElementById('bible-diff-list-container')
            ].filter(c => c);  // Filter out null elements

            if (containers.length === 0) return;

            if (articles.length === 0) {
                containers.forEach(container => {
                    container.innerHTML = '<p class="text-gray-500 text-center py-2">No matching questions</p>';
                });
                return;
            }

            // Remove duplicates based on URL (skip if already deduplicated)
            let uniqueArticles = articles;
            if (!skipDedup) {
                const seenUrls = new Set();
                uniqueArticles = articles.filter(article => {
                    if (seenUrls.has(article.url)) {
                        return false;
                    }
                    seenUrls.add(article.url);
                    return true;
                });
            }

            // Limit to first 100 to avoid overwhelming the DOM
            const displayArticles = uniqueArticles.slice(0, 500); // Increased limit to 500

            const html = displayArticles.map(article => {
                const book = extractBookFromArticle(article);

                // Get source color based on source
                let sourceColor = 'text-gray-400';
                if (article.source === 'kjvtoday.net') {
                    sourceColor = 'text-yellow-400';
                } else if (article.source === 'answersingenesis.org') {
                    sourceColor = 'text-blue-400';
                } else if (article.source === 'christcreated.com') {
                    sourceColor = 'text-purple-400';
                } else if (article.source === 'lighthousetrailsresearch.com') {
                    sourceColor = 'text-orange-400';
                } else {
                    // defendinginerrancy.com
                    sourceColor = 'text-green-400';
                }
                const sourceLabel = article.source.replace('.com', '').replace('.net', '').replace('.org', '');

                return `
                    <a href="${article.url}" target="_blank"
                       class="block bg-gray-700/50 hover:bg-blue-900/30 border border-gray-700 hover:border-blue-700/50 rounded px-2 py-1.5 transition-colors">
                        <div class="flex items-start gap-2">
                            <span class="text-blue-300 font-medium text-[10px] uppercase flex-shrink-0 mt-0.5">${book}</span>
                            <span class="text-gray-300 leading-tight flex-1">${article.title}</span>
                            <span class="text-[9px] ${sourceColor} flex-shrink-0 opacity-70">${sourceLabel}</span>
                        </div>
                    </a>
                `;
            }).join('');

            if (uniqueArticles.length > 100) {
                const moreHtml = `
                    <p class="text-gray-500 text-center py-2 text-[10px]">
                        Showing 100 of ${uniqueArticles.length} questions. Search for specific topics.
                    </p>
                `;
                containers.forEach(container => {
                    container.innerHTML = html + moreHtml;
                });
            } else {
                containers.forEach(container => {
                    container.innerHTML = html;
                });
            }
        };

        window.renderBibleDifficultiesByBook = function(book) {
            if (!window.bibleDifficulties || window.bibleDifficulties.length === 0) {
                window.renderBibleDifficulties([]);
                return;
            }

            applySourceFilter();
        };

        function selectBook(book) {
            activeBook = activeBook === book ? null : book;
            document.querySelectorAll('.sidebar-book').forEach(el => {
                el.classList.toggle('active', el.dataset.book === activeBook);
            });

            // Update current chapter view
            if (activeBook) {
                const bookChapters = chapters.filter(c => c.book === activeBook);
                currentChapterView = bookChapters[0]; // Show first chapter
                showDetails(currentChapterView);

                // Filter Bible difficulties for this book
                window.renderBibleDifficultiesByBook(activeBook);

                // Show filter label
                ['bible-diff-filter-label-container'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.remove('hidden');
                });
                ['bible-diff-book-label-container'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = activeBook;
                });
                ['bible-diff-search-overlay', 'bible-diff-search-container'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.placeholder = `Search in ${activeBook}...`;
                });
            } else {
                currentChapterView = null;
                document.getElementById('detail-content').innerHTML =
                    '<p class="text-gray-500">Click on a chapter to see details</p>';
                document.getElementById('details-toggle').classList.add('hidden');

                // Show all Bible difficulties when no book is selected (with source filters applied)
                applySourceFilter();

                // Hide filter label
                ['bible-diff-filter-label-container'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
                ['bible-diff-search-overlay', 'bible-diff-search-container'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.placeholder = 'Search questions...';
                });
            }

            // Re-run verse search if one is active (updates both arcs and Bible difficulties)
            if (searchQuery && isVerseSearch) {
                performVerseSearch(searchQuery, null);  // Don't auto-render, we'll call it below
            } else {
                // If no verse search, apply normal source filter
                applySourceFilter();
            }

            render();
        }

        // Perform verse search (can be called from input handler or book filter change)
        function performVerseSearch(query, callback) {
            // Try to parse as Bible verse reference (e.g., "john 3:16", "gen 1:1-3")
            const verseRefMatch = query.match(/^([a-z0-9]+)\s*(\d+)(?::(\d+)(?:-(\d+))?)?$/);
            if (verseRefMatch) {
                const bookPart = verseRefMatch[1].toLowerCase();
                const chapter = parseInt(verseRefMatch[2]);
                const verseStart = verseRefMatch[3] ? parseInt(verseRefMatch[3]) : null;
                const verseEnd = verseRefMatch[4] ? parseInt(verseRefMatch[4]) : null;

                // Find matching book
                const bookNames = BOOK_NAMES.filter(b =>
                    b.toLowerCase() === bookPart ||
                    b.toLowerCase().startsWith(bookPart) ||
                    bookPart === b.toLowerCase().replace(/\s/g, '').substring(0, bookPart.length)
                );

                if (bookNames.length > 0) {
                    isVerseSearch = true;
                    const book = bookNames[0];
                    // Get lookup book name for verse text
                    const lookupBook = normalizeBookNameForText(book);

                    // Clear previous search verse refs
                    searchVerseRefs = [];

                    if (verseStart !== null) {
                        // Specific verse or verse range
                        if (verseEnd !== null) {
                            // Range of verses (e.g., Genesis 1:1-3)
                            for (let v = verseStart; v <= verseEnd; v++) {
                                searchVerseRefs.push(`${book} ${chapter}:${v}`);
                            }
                        } else {
                            // Single verse (e.g., John 3:16)
                            searchVerseRefs.push(`${book} ${chapter}:${verseStart}`);
                        }
                    } else {
                        // Whole chapter (e.g., Genesis 1) - add all verses
                        let v = 1;
                        while (verseTexts[`${lookupBook} ${chapter}:${v}`]) {
                            searchVerseRefs.push(`${book} ${chapter}:${v}`);
                            v++;
                        }
                    }

                    // For verse search: find arcs that have source or target matching the search verse(s)
                    // Only show direct connections, not traversed connections
                    searchConnectedVerseRefs = new Set(searchVerseRefs);

                    // Find direct incoming and outgoing references for each search verse
                    for (const searchVerse of searchVerseRefs) {
                        // Outgoing: target verses
                        const outgoing = crossRefs[searchVerse] || [];
                        for (const ref of outgoing) {
                            searchConnectedVerseRefs.add(ref.to);
                        }

                        // Incoming: source verses (using reverse index)
                        const incoming = incomingRefs[searchVerse] || [];
                        for (const ref of incoming) {
                            searchConnectedVerseRefs.add(ref.source);
                        }
                    }

                    // Find arcs that connect to/from the search verses
                    // If a book filter is active, also require that the arc connects to that book
                    searchArcIds.clear();
                    for (const arc of window.verseArcs || []) {
                        if (searchArcIds.size < 1000) {  // Limit for performance
                            const arcId = `${arc.sourceRef}->${arc.targetRef}`;
                            const connectsToSearchVerse = searchVerseRefs.includes(arc.sourceRef) ||
                                                        searchVerseRefs.includes(arc.targetRef);

                            if (!connectsToSearchVerse) continue;

                            // If a book filter is active, require that the arc connects to that book
                            if (activeBook) {
                                const connectsToBook = arc.sourceRef.startsWith(activeBook + ' ') ||
                                                      arc.targetRef.startsWith(activeBook + ' ');
                                if (!connectsToBook) continue;
                            }

                            searchArcIds.add(arcId);
                        }
                    }

                    console.log(`Search: ${searchVerseRefs.length} search verses ‚Üí ${searchConnectedVerseRefs.size} connected verses ‚Üí ${searchArcIds.size} arcs`);

                    // Also filter Bible difficulties to show only relevant articles
                    filterBibleDifficultiesByVerse(searchVerseRefs);
                }
            }
            if (callback) callback();
        }

        // Helper function to match verse references with different book name formats
        function verseRefsMatch(searchRef, dbVerse) {
            // Direct match
            if (searchRef === dbVerse) return true;

            // Try to normalize both references for comparison
            const normalizeRef = (ref) => {
                const parts = ref.split(' ');
                let book = parts[0];
                const rest = parts.slice(1).join(' ');  // "1:28"

                // Handle common book abbreviations
                const abbreviations = {
                    'Gen': 'Genesis', 'Exod': 'Exodus', 'Ex': 'Exodus',
                    'Lev': 'Leviticus', 'Num': 'Numbers', 'Deut': 'Deuteronomy',
                    'Josh': 'Joshua', 'Judg': 'Judges', 'Ruth': 'Ruth',
                    '1Sam': '1 Samuel', '2Sam': '2 Samuel', '1Kgs': '1 Kings', '2Kgs': '2 Kings',
                    '1Chron': '1 Chronicles', '2Chron': '2 Chronicles', 'Ezra': 'Ezra', 'Neh': 'Nehemiah',
                    'Esther': 'Esther', 'Job': 'Job', 'Ps': 'Psalms', 'Psalm': 'Psalms',
                    'Prov': 'Proverbs', 'Eccl': 'Ecclesiastes', 'Song': 'Song of Solomon',
                    'Isa': 'Isaiah', 'Jer': 'Jeremiah', 'Lam': 'Lamentations', 'Ezek': 'Ezekiel',
                    'Dan': 'Daniel', 'Hos': 'Hosea', 'Joel': 'Joel', 'Amos': 'Amos',
                    'Obad': 'Obadiah', 'Jonah': 'Jonah', 'Mic': 'Micah', 'Nahum': 'Nahum',
                    'Hab': 'Habakkuk', 'Zeph': 'Zephaniah', 'Hag': 'Haggai', 'Zech': 'Zechariah',
                    'Mal': 'Malachi', 'Matt': 'Matthew', 'Mk': 'Mark', 'Mk': 'Mark',
                    'Lk': 'Luke', 'John': 'John', 'Jn': 'John', 'Acts': 'Acts',
                    'Rom': 'Romans', '1Cor': '1 Corinthians', '2Cor': '2 Corinthians',
                    'Gal': 'Galatians', 'Eph': 'Ephesians', 'Phil': 'Philippians',
                    'Col': 'Colossians', '1Thess': '1 Thessalonians', '2Thess': '2 Thessalonians',
                    '1Tim': '1 Timothy', '2Tim': '2 Timothy', 'Titus': 'Titus', 'Phlm': 'Philemon',
                    'Heb': 'Hebrews', 'Jas': 'James', '1Pet': '1 Peter', '2Pet': '2 Peter',
                    '1John': '1 John', '2John': '2 John', '3John': '3 John',
                    'Jude': 'Jude', 'Rev': 'Revelation'
                };

                // Normalize book name
                if (abbreviations[book]) {
                    book = abbreviations[book];
                }

                return `${book} ${rest}`;
            };

            try {
                return normalizeRef(searchRef) === normalizeRef(dbVerse);
            } catch (e) {
                return false;
            }
        }

        // Filter Bible difficulties by verse references
        function filterBibleDifficultiesByVerse(verseRefs) {
            if (!window.bibleDifficulties || window.bibleDifficulties.length === 0) return;

            // Find articles whose bible_verse field matches any of the search verses
            const filtered = window.bibleDifficulties.filter(article => {
                if (!article.bible_verse) return false;

                // bible_verse can be a single verse or array
                const verses = Array.isArray(article.bible_verse) ? article.bible_verse : [article.bible_verse];

                // Check if any verse matches (using flexible matching)
                return verses.some(dbVerse => verseRefs.some(searchRef => verseRefsMatch(searchRef, dbVerse)));
            });

            // Store for further filtering (by source or search text)
            verseFilteredBibleDifficulties = filtered;

            // Apply source filters to the verse search results
            if (activeSourceFilters.size > 0) {
                const withSourceFilter = filtered.filter(article => !activeSourceFilters.has(article.source));
                window.renderBibleDifficulties(withSourceFilter, true);
            } else {
                window.renderBibleDifficulties(filtered, true);
            }
        }

        function resize() {
            const container = document.getElementById('viz-container');
            width = container.clientWidth;
            height = container.clientHeight;
            canvas.width = width * window.devicePixelRatio;
            canvas.height = height * window.devicePixelRatio;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            render();
        }

        function setupEvents() {
            // Mobile slider sync
            const mobileVoteSlider = document.getElementById('vote-threshold-mobile');
            const mobileArcSlider = document.getElementById('arc-limit-mobile');
            const desktopVoteSlider = document.getElementById('vote-threshold');
            const desktopArcSlider = document.getElementById('arc-limit');

            if (mobileVoteSlider) {
                mobileVoteSlider.oninput = (e) => {
                    voteThreshold = parseInt(e.target.value);
                    document.getElementById('vote-value-mobile').textContent = voteThreshold;
                    if (desktopVoteSlider) desktopVoteSlider.value = voteThreshold;
                    document.getElementById('vote-value').textContent = voteThreshold;
                    if (currentChapterView) showDetails(currentChapterView);
                    render();
                };
            }
            if (mobileArcSlider) {
                mobileArcSlider.oninput = (e) => {
                    arcLimit = parseInt(e.target.value);
                    document.getElementById('arc-value-mobile').textContent = arcLimit;
                    if (desktopArcSlider) desktopArcSlider.value = arcLimit;
                    document.getElementById('arc-value').textContent = arcLimit;
                    render();
                };
            }

            document.getElementById('vote-threshold').oninput = (e) => {
                voteThreshold = parseInt(e.target.value);
                document.getElementById('vote-value').textContent = voteThreshold;

                // Refresh details panel if a chapter is active
                if (currentChapterView) {
                    showDetails(currentChapterView);
                }
                render();
            };
            document.getElementById('arc-limit').oninput = (e) => {
                arcLimit = parseInt(e.target.value);
                document.getElementById('arc-value').textContent = arcLimit;
                render();
            };
            let searchTimeout;
            document.getElementById('search-input').oninput = (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = e.target.value.toLowerCase().trim();
                    searchQuery = query;

                    // Only process if query is non-empty
                    if (!query) {
                        searchVerseRefs = [];
                        searchConnectedVerseRefs.clear();
                        searchArcIds.clear();
                        verseFilteredBibleDifficulties = [];  // Clear verse-filtered Bible difficulties
                        isVerseSearch = false;
                        applySourceFilter();  // Reset Bible difficulties to normal
                        render();
                        return;
                    }

                    // Reset search state
                    searchVerseRefs = [];
                    searchConnectedVerseRefs.clear();
                    searchArcIds.clear();
                    isVerseSearch = false;
                    verseFilteredBibleDifficulties = [];

                    performVerseSearch(query, render);
                }, 200);
            };
            window.onresize = () => { resize(); };
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                // Store in CSS pixels (same coordinates used for arc calculations)
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
                handleHover(e);
                updateHover();
            });
            canvas.addEventListener('click', handleClick);
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length > 0) {
                    const touch = e.touches[0];
                    const rect = canvas.getBoundingClientRect();
                    mouseX = touch.clientX - rect.left;
                    mouseY = touch.clientY - rect.top;
                    updateHover();
                }
            }, { passive: false });
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                // Get the touch position from the last known touch or use changedTouches
                let touchX = mouseX, touchY = mouseY;
                if (e.changedTouches && e.changedTouches.length > 0) {
                    const rect = canvas.getBoundingClientRect();
                    touchX = e.changedTouches[0].clientX - rect.left;
                    touchY = e.changedTouches[0].clientY - rect.top;
                }

                const layout = window.layout;
                if (!layout) return;

                // Check if we tapped on an arc
                const clickedArc = findArcAtPosition(touchX, touchY);
                if (clickedArc) {
                    selectedArc = clickedArc;
                    currentChapterView = chapters[clickedArc.sourcePos.chapterIdx];
                    showDetails(currentChapterView);
                    render();
                    return;
                }

                // Otherwise check if we tapped on a chapter
                const idx = Math.floor((touchX - layout.margin.left) / layout.chapterWidth);
                if (idx >= 0 && idx < layout.visible.length) {
                    selectedArc = null;
                    currentChapterView = layout.visible[idx];
                    showDetails(currentChapterView);
                    render();
                }
            }, { passive: false });
        }

        function getVisibleChapters() {
            let startIdx = 0, endIdx = chapters.length - 1;

            if (activeBook) {
                for (let ch of chapters) {
                    if (ch.book === activeBook) {
                        startIdx = ch.index;
                        break;
                    }
                }
                for (let i = chapters.length - 1; i >= 0; i--) {
                    if (chapters[i].book === activeBook) {
                        endIdx = i;
                        break;
                    }
                }
            }

            if (searchQuery) {
                const matches = chapters.filter(c =>
                    `${c.book} ${c.chapter}`.toLowerCase().includes(searchQuery)
                );
                if (matches.length > 0) {
                    // Book/chapter search found
                    const positions = matches.map(c => c.index);
                    startIdx = Math.min(...positions);
                    endIdx = Math.max(...positions);
                } else if (searchArcIds.size > 0) {
                    // Verse/arc search found - show all chapters that have matching arcs
                    for (const arc of window.verseArcs || []) {
                        if (searchArcIds.has(`${arc.sourceRef}->${arc.targetRef}`)) {
                            startIdx = Math.min(startIdx, arc.sourcePos.chapterIdx, arc.targetPos.chapterIdx);
                            endIdx = Math.max(endIdx, arc.sourcePos.chapterIdx, arc.targetPos.chapterIdx);
                        }
                    }
                }
            }

            // Return all visible chapters - we handle theme filtering visually in render
            return chapters.slice(startIdx, endIdx + 1);
        }

        function render() {
            ctx.fillStyle = '#111827';
            ctx.fillRect(0, 0, width, height);

            const visible = getVisibleChapters();
            if (visible.length === 0) return;

            // Layout - arcs take up most space, histogram directly below
            const margin = { left: 15, right: 15 };
            const topPadding = 20;

            // Arcs fill most of height, histogram at bottom
            const arcAreaHeight = height * 0.85;  // 85% for arc area
            const histHeight = Math.min(100, height * 0.12);  // Up to 12% for histogram
            const arcTop = topPadding;
            const arcBottom = arcTop + arcAreaHeight;  // Bottom of arc area
            const arcRowY = arcBottom;  // Arc baseline at bottom edge, curves go up
            const histTop = arcBottom;  // Histogram starts right below arc area

            const chapterWidth = (width - margin.left - margin.right) / visible.length;

            // Store layout for interaction
            window.layout = {
                visible,
                chapterWidth,
                arcRowY,
                arcAreaHeight,
                margin,
                arcTop,
                arcBottom,
                histTop,
                histHeight,
                allArcs: []  // Store for hover detection
            };

            // Dynamically position overlays to cover space below arcs
            // Canvas offset - use consistent value across devices
            const canvasOffset = 0.3 * window.innerHeight;  // 30vh in pixels

            const statusOverlay = document.getElementById('status-bar-overlay');
            const bibleDiffOverlay = document.getElementById('bible-diff-overlay');

            // Visual position of arc bottom relative to viz-container top
            const visualArcBottom = arcBottom - canvasOffset;
            if (visualArcBottom >= 0) {
                // Position status bar overlay at visual arc bottom
                statusOverlay.style.top = `${visualArcBottom}px`;
                statusOverlay.style.display = 'flex';

                // Position bible difficulties overlay below status bar
                // Give it bottom: 0 so it fills remaining space and is scrollable
                const statusHeight = 32;  // h-8 = 32px
                bibleDiffOverlay.style.top = `${visualArcBottom + statusHeight}px`;
                bibleDiffOverlay.style.bottom = '0';
                bibleDiffOverlay.style.display = 'block';
            } else {
                // Arcs are still above container, hide overlays
                statusOverlay.style.display = 'none';
                bibleDiffOverlay.style.display = 'none';
                bibleDiffOverlay.style.bottom = 'auto';
            }

            // Draw reference line for arcs
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin.left, arcRowY);
            ctx.lineTo(width - margin.right, arcRowY);
            ctx.stroke();

            // Compute chapter positions
            visible.forEach((c, i) => {
                const x = margin.left + i * chapterWidth + chapterWidth / 2;
                c.x = x;

                // Store normalized position for hover detection
                c.layoutX = x / window.devicePixelRatio;
            });

            // Compute max ref count at verse level for histogram scaling
            let maxVerseRefCount = 0;
            visible.forEach(c => {
                c.verseRefs.forEach(vr => {
                    if (vr.refCount > maxVerseRefCount) {
                        maxVerseRefCount = vr.refCount;
                    }
                });
            });
            const maxRef = Math.max(maxVerseRefCount, 1);

            // Draw arcs using verse-level arcs
            ctx.globalAlpha = 0.3;

            let allArcs = [];

            // Get visible chapter indices
            const visibleIndices = new Set(visible.map(ch => ch.index));

            // Filter verse arcs to those where either source or target is visible
            let visibleArcs = [];
            for (const arc of window.verseArcs || []) {
                if (arc.votes < voteThreshold) continue;

                const sourceVisible = visibleIndices.has(arc.sourcePos.chapterIdx);
                const targetVisible = visibleIndices.has(arc.targetPos.chapterIdx);

                // Only show arcs where target is visible (for TO visualization)
                if (!targetVisible) continue;

                visibleArcs.push({
                    ...arc,
                    sourceVisible,
                    targetVisible
                });
            }

            // Sort by votes and limit
            visibleArcs.sort((a, b) => b.votes - a.votes);

            // Filter arcs for verse search - ONLY show matching arcs
            const adaptiveArcLimit = visible.length < 20 ? arcLimit * 3 : arcLimit;
            const limitedVisibleArcs = isVerseSearch
                ? visibleArcs.filter(a => searchArcIds.has(`${a.sourceRef}->${a.targetRef}`))
                : visibleArcs.slice(0, adaptiveArcLimit);

            // Calculate x positions for each verse arc
            for (const arc of limitedVisibleArcs) {
                // Calculate source X
                const sourceChIdx = arc.sourcePos.chapterIdx;
                const sourceCh = arc.sourceChapter;

                let sourceX;
                const sourceVisibleIdx = visible.findIndex(v => v.index === sourceChIdx);
                if (sourceVisibleIdx !== -1) {
                    // Source is visible - calculate precise verse position
                    const chWidth = chapterWidth;
                    const verseOffset = (arc.sourcePos.verseIndex / sourceCh.verseCount) * chWidth;
                    sourceX = margin.left + sourceVisibleIdx * chWidth + verseOffset;
                } else {
                    // Source is off-screen - approximate position
                    const fullWidth = width - margin.left - margin.right;
                    const chapterStep = fullWidth / chapters.length;
                    sourceX = margin.left + sourceChIdx * chapterStep + chapterStep / 2;
                    sourceX = Math.max(0, Math.min(width, sourceX));
                }

                // Calculate target X (always use precise verse position)
                const targetChIdx = arc.targetPos.chapterIdx;
                const targetCh = arc.targetChapter;
                const targetVisibleIdx = visible.findIndex(v => v.index === targetChIdx);
                const chWidth = chapterWidth;
                const verseOffset = (arc.targetPos.verseIndex / targetCh.verseCount) * chWidth;
                const targetX = margin.left + targetVisibleIdx * chWidth + verseOffset;

                allArcs.push({
                    id: `${arc.sourceRef}->${arc.targetRef}`,  // Unique identifier
                    x1: sourceX,
                    x2: targetX,
                    y: arcRowY,
                    y1: arcRowY,
                    y2: arcRowY + (arcAreaHeight * 0.85),
                    height: arcAreaHeight * 0.85,  // Use 85% of vertical space
                    votes: arc.votes,
                    sourceColor: getVerseTheme(sourceCh.book, sourceCh.chapter, arc.sourcePos.verseIndex + 1).color,
                    targetColor: getVerseTheme(targetCh.book, targetCh.chapter, arc.targetPos.verseIndex + 1).color,
                    sourceTheme: getVerseTheme(sourceCh.book, sourceCh.chapter, arc.sourcePos.verseIndex + 1),
                    targetTheme: getVerseTheme(targetCh.book, targetCh.chapter, arc.targetPos.verseIndex + 1),
                    fromChapter: sourceCh,
                    toChapter: targetCh,
                    sourceRef: arc.sourceRef,
                    targetRef: arc.targetRef,
                    fromVisible: arc.sourceVisible,
                    sourceVerseIdx: arc.sourcePos.verseIndex,
                    targetVerseIdx: arc.targetPos.verseIndex,
                    sourcePos: arc.sourcePos,
                    targetPos: arc.targetPos
                });
            }

            window.layout.allArcs = allArcs;

            // Store processed arcs for navigation (after they have x positions and theme info)
            visibleArcsForNavigation = allArcs;

            // Determine which arcs to draw last (on top)
            const hoveredArcToDrawLast = hoveredArc;
            const isAnyHovered = !!hoveredArc;
            const isAnySelected = !!selectedArc;

            for (const arc of allArcs) {
                // Skip hovered/selected arcs - we'll draw them last
                const arcIsHovered = hoveredArcToDrawLast && arc.id === hoveredArcToDrawLast.id;
                const arcIsSelected = selectedArc && arc.id === selectedArc.id;
                if (arcIsHovered || arcIsSelected) continue;

                const dx = Math.abs(arc.x2 - arc.x1);
                const minDrawDist = 10; // Minimum horizontal distance to draw
                if (dx < minDrawDist) continue;

                // Calculate base opacity
                let baseOpacity = arc.fromVisible ? 0.4 : 0.25;

                // Highlight search-matched arcs
                const isSearchMatch = searchArcIds.has(arc.id);
                if (isSearchMatch) {
                    baseOpacity = 0.8;  // Very prominent for search results
                }

                // When a theme filter is active, boost arcs FROM that theme
                if (activeTheme) {
                    const fromMatchesTheme = arc.sourceTheme.name === activeTheme;
                    const toMatchesTheme = arc.targetTheme.name === activeTheme;

                    if (fromMatchesTheme) {
                        baseOpacity = 0.7;  // Much more prominent
                    } else if (toMatchesTheme) {
                        baseOpacity = 0.5;  // Moderately visible
                    } else {
                        baseOpacity = 0.05;  // Fade almost completely
                    }
                }

                // Fade all arcs more if something is hovered or selected
                // But keep search matches prominent
                if ((isAnyHovered || isAnySelected) && !arcIsHovered && !arcIsSelected && !isSearchMatch) {
                    baseOpacity *= 0.15;
                } else if ((isAnyHovered || isAnySelected) && !arcIsHovered && !arcIsSelected && isSearchMatch) {
                    baseOpacity *= 0.5;  // Dim but still visible when hovering/selected
                }

                drawGradientArc(ctx, arc, baseOpacity, false);
            }

            ctx.globalAlpha = 1;

            // Draw selected arc on top (if any)
            if (selectedArc) {
                const arc = allArcs.find(a => a.id === selectedArc.id);
                if (arc) {
                    const dx = Math.abs(arc.x2 - arc.x1);
                    if (dx >= 10) {
                        drawGradientArc(ctx, arc, 0.85, true);
                    }
                }
            }

            // Draw hovered arc on top
            if (hoveredArcToDrawLast) {
                const arc = allArcs.find(a => a.id === hoveredArcToDrawLast.id);
                if (arc) {
                    const dx = Math.abs(arc.x2 - arc.x1);
                    if (dx >= 10) { // Only draw if sufficient distance
                        drawGradientArc(ctx, arc, 1.0, true);

                        // Redraw highlighted tick marks on top of the hovered arc
                        visible.forEach((c, i) => {
                            const hoveredSourceX = arc.x1;
                            const hoveredTargetX = arc.x2;
                            const myX = c.x;
                            const isHighlighted =
                                Math.abs(hoveredSourceX - myX) < chapterWidth / 2 ||
                                Math.abs(hoveredTargetX - myX) < chapterWidth / 2;

                            if (isHighlighted) {
                                ctx.beginPath();
                                ctx.moveTo(c.x, arcRowY);
                                ctx.lineTo(c.x, arcRowY + 4);
                                ctx.strokeStyle = arc.sourceColor;
                                ctx.lineWidth = 2.5;
                                ctx.stroke();
                            }
                        });
                    }
                }
            }

            // Draw labels - show arc-specific labels when hovering/selected, otherwise book/chapter labels
            const isArcHovered = !!hoveredArc;
            const isArcSelected = !!selectedArc;

            // Use selected arc for labels if present, otherwise hovered arc
            const arcForLabels = selectedArc || hoveredArc;
            const shouldShowArcLabels = isArcSelected || isArcHovered;

            if (shouldShowArcLabels) {
                // Draw labels for the arc's endpoints
                const font = '10px sans-serif';
                const yOffset = arcRowY + 20;  // Below the baseline

                ctx.font = font;
                ctx.textAlign = 'center';

                // Parse source reference: "Book Chapter:Verse" e.g., "Genesis 1:1"
                const sourceParts = arcForLabels.sourceRef.split(' ');
                const sourceBook = sourceParts[0];
                const sourceChVerse = sourceParts.slice(1).join(' ');  // "1:1"
                const [sourceCh, sourceVerse] = sourceChVerse.split(':');

                ctx.fillStyle = arcForLabels.sourceColor;

                ctx.shadowColor = '#111827';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;

                // Show book name on top, chapter:verse below
                ctx.fillText(sourceBook, arcForLabels.x1, yOffset);
                ctx.font = '9px sans-serif';
                ctx.fillText(`${sourceCh}:${sourceVerse}`, arcForLabels.x1, yOffset + 11);

                // Parse target reference
                const targetParts = arcForLabels.targetRef.split(' ');
                const targetBook = targetParts[0];
                const targetChVerse = targetParts.slice(1).join(' ');  // "1:1"
                const [targetCh, targetVerse] = targetChVerse.split(':');

                ctx.fillStyle = arcForLabels.targetColor;
                ctx.font = font;

                ctx.fillText(targetBook, arcForLabels.x2, yOffset);
                ctx.font = '9px sans-serif';
                ctx.fillText(`${targetCh}:${targetVerse}`, arcForLabels.x2, yOffset + 11);

                ctx.shadowBlur = 0;  // Reset shadow
            } else {
                // Default book labels - show only 5 key books for scale reference
                const scaleBooks = ['Genesis', ['Psalm', 'Psalms'], 'Isaiah', 'Matthew', 'Revelation'];
                ctx.fillStyle = '#9ca3af';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'center';

                let lastBook = '';
                let lastScaleIdx = -1;

                for (const ch of visible) {
                    if (ch.book !== lastBook) {
                        // Check if this book matches any of the scale books
                        const scaleIdx = scaleBooks.findIndex(sb =>
                            typeof sb === 'string' ? sb === ch.book : sb.includes(ch.book)
                        );
                        if (scaleIdx !== -1 && scaleIdx > lastScaleIdx) {
                            ctx.fillText(ch.book, ch.x, arcRowY + 35);
                            lastScaleIdx = scaleIdx;
                        }
                        lastBook = ch.book;
                    }
                }
            }

            // Draw histogram inverted (verse-level bars hang down from arc line)
            visible.forEach((c, i) => {
                const chWidth = chapterWidth;

                // Draw verse-level bars
                c.verseRefs.forEach(vr => {
                    if (vr.refCount === 0) return;  // Skip verses with no refs

                    // Check if this verse matches the active theme filter
                    let themeOpacity = 1.0;
                    if (activeTheme) {
                        // Use the stored theme name directly
                        themeOpacity = vr.themeName === activeTheme ? 1.0 : 0.15;
                    }

                    // Calculate bar width (evenly distributed across verse count)
                    // Using a small gap between bars
                    const barWidth = Math.max(1, (chWidth / c.verseCount) - 0.5);
                    const verseX = margin.left + i * chWidth + (vr.verseIndex - 1) * (chWidth / c.verseCount) + 0.25;

                    // Calculate bar height
                    const barHeight = (vr.refCount / maxRef) * histHeight;
                    const y = histTop;  // Bars start at top of histogram area (arc line level)

                    // Only draw if theme opacity is significant
                    if (themeOpacity < 0.1) return;

                    // Create gradient based on verse theme - top is solid, bottom is transparent
                    const gradient = ctx.createLinearGradient(verseX, y, verseX, y + barHeight);

                    // Apply theme opacity to the gradient
                    const hexColor = vr.theme;
                    const rgb = hexToRgb(hexColor);
                    const fadedColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${0.8 * themeOpacity})`;
                    const transparentColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${0.25 * themeOpacity})`;

                    gradient.addColorStop(0, fadedColor);
                    gradient.addColorStop(1, transparentColor);  // Add transparency at bottom

                    ctx.globalAlpha = themeOpacity;
                    ctx.fillStyle = gradient;
                    ctx.fillRect(verseX, y, barWidth, barHeight);

                    // Top border for bar (at arc line level) - only for bars with significant height
                    if (barHeight >= 2) {
                        ctx.strokeStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${0.38 * themeOpacity})`;
                        ctx.lineWidth = 0.5;
                        ctx.strokeRect(verseX, y, barWidth, barHeight);
                    }
                });

                ctx.globalAlpha = 1.0;  // Reset alpha
            });

            // Histogram baseline (at bottom of histogram bars)
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin.left, histTop + histHeight);
            ctx.lineTo(width - margin.right, histTop + histHeight);
            ctx.stroke();

            const statusText = `${visible.length} chapters, ${allArcs.length} arcs shown`;
            ['status-bar', 'status-bar-overlay'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = statusText;
            });
        }

        function handleHover(e) {
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio;
            const x = (e.clientX - rect.left) * dpr;  // Canvas coordinates
            const y = (e.clientY - rect.top) * dpr;

            const layout = window.layout;
            if (!layout) return;

            // Find chapter - layout.margin.left and layout.chapterWidth are in canvas coordinates
            const idx = Math.floor((x - layout.margin.left) / layout.chapterWidth);
            if (idx >= 0 && idx < layout.visible.length) {
                const ch = layout.visible[idx];
                const html = `<span class="text-blue-400">${ch.book} ${ch.chapter}</span> ‚Ä¢ ${ch.refCount} refs ‚Ä¢ Click for details`;
                ['status-bar', 'status-bar-overlay'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = html;
                });
            }
        }

        function handleClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;  // CSS pixels
            const y = e.clientY - rect.top;   // CSS pixels

            const layout = window.layout;
            if (!layout) return;

            // First check if we clicked on an arc
            const clickedArc = findArcAtPosition(x, y);
            if (clickedArc) {
                selectedArc = clickedArc;
                const arcId = clickedArc.id;
                // Focus on the source chapter of the selected arc
                currentChapterView = chapters[clickedArc.sourcePos.chapterIdx];
                showDetails(currentChapterView);
                render(); // Re-render to show arc selection
                // AFTER render, find the arc in the NEW navigation array
                const navIndex = visibleArcsForNavigation.findIndex(a => a.id === arcId);
                if (navIndex !== -1) {
                    currentArcIndex = navIndex;
                } else {
                    currentArcIndex = visibleArcsForNavigation.length > 0 ? 0 : -1;
                }
                currentArcId = arcId;
                return;
            }

            // Otherwise, check if we clicked on a chapter
            const idx = Math.floor((x - layout.margin.left) / layout.chapterWidth);
            if (idx >= 0 && idx < layout.visible.length) {
                selectedArc = null; // Clear arc selection
                currentChapterView = layout.visible[idx];
                showDetails(currentChapterView);
                render();
            }
        }

        function findArcAtPosition(x, y) {
            const layout = window.layout;
            if (!layout || !layout.allArcs) return null;

            // Use larger tolerance for touch/mobile devices
            const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const maxDistance = isTouch ? 35 : 15; // pixels - tighter tolerance for clicking, looser for touch

            for (const arc of layout.allArcs) {
                const dx = Math.abs(arc.x2 - arc.x1);
                if (dx < 5) continue;

                const midX = (arc.x1 + arc.x2) / 2;
                const curveHeight = Math.min(dx * 0.75, arc.height * 1.3);
                const ctrlY = arc.y - curveHeight;

                // Quick bounding box check
                const arcMaxDist = maxDistance + 10;
                const minX = Math.min(arc.x1, arc.x2) - arcMaxDist;
                const maxX = Math.max(arc.x1, arc.x2) + arcMaxDist;
                const minY = arc.y - curveHeight - arcMaxDist;
                const maxY = arc.y + arcMaxDist;

                if (x < minX || x > maxX || y < minY || y > maxY) continue;

                // Sample the arc
                const sampleCount = Math.min(Math.max(Math.floor(dx / 3), 30), 120);

                for (let t = 0; t <= 1; t += 1 / sampleCount) {
                    const t1 = (1 - t) * (1 - t);
                    const t2 = 2 * (1 - t) * t;
                    const t3 = t * t;

                    const curveX = t1 * arc.x1 + t2 * midX + t3 * arc.x2;
                    const curveY = t1 * arc.y + t2 * ctrlY + t3 * arc.y;

                    const dist = Math.sqrt(Math.pow(x - curveX, 2) + Math.pow(y - curveY, 2));

                    if (dist <= maxDistance) {
                        return arc;
                    }
                }
            }

            return null;
        }

        function showDetails(chapter) {
            const panel = document.getElementById('detail-content');

            // Show details FAB on mobile
            const detailsToggle = document.getElementById('details-toggle');
            if (detailsToggle) {
                detailsToggle.classList.remove('hidden');
                // Open details panel on mobile
                if (window.innerWidth <= 640) {
                    document.getElementById('details-panel').classList.add('open');
                    document.getElementById('drawer-overlay').classList.add('show');
                }
            }

            // Get all verses in this chapter with their cross-references
            const chapterVerses = [];
            let v = 1;

            // Use normalized book name to find verses
            const lookupBook = normalizeBookNameForText(chapter.book);

            while (verseTexts[`${lookupBook} ${chapter.chapter}:${v}`]) {
                const ref = `${chapter.book} ${chapter.chapter}:${v}`;
                const verseRefs = (crossRefs[ref] || []).filter(r => r.votes >= voteThreshold);

                if (verseRefs.length > 0) {
                    // Get verse text using helper for normalization
                    const text = getVerseText(ref) || '';

                    // Count incoming refs (filtered by vote threshold)
                    let incomingCount = 0;
                    const incomingRefs = [];
                    for (const [source, refs] of Object.entries(crossRefs)) {
                        if (refs && refs.length > 0) {
                            const sourcePos = versePositions[source];
                            if (sourcePos && sourcePos.chapterIdx === chapter.index) {
                                const incomingForVerse = refs.filter(r => r.to === ref && r.votes >= voteThreshold);
                                incomingCount += incomingForVerse.length;
                                incomingRefs.push(...incomingForVerse);
                            }
                        }
                    }

                    chapterVerses.push({
                        ref,
                        text: text,
                        outgoingCount: verseRefs.length,
                        incomingCount: incomingRefs.length,
                        totalRefs: verseRefs.length + incomingRefs.length,
                        topRefs: verseRefs.sort((a,b) => b.votes - a.votes),
                        incomingRefs: incomingRefs
                    });
                }
                v++;
            }

            // Sort by number of references (descending), but put selected arc's source verse at top
            if (selectedArc && selectedArc.sourcePos.chapterIdx === chapter.index) {
                const selectedRef = selectedArc.sourceRef;
                chapterVerses.sort((a, b) => {
                    const aIsSelected = a.ref === selectedRef;
                    const bIsSelected = b.ref === selectedRef;
                    if (aIsSelected) return -1;
                    if (bIsSelected) return 1;
                    return b.totalRefs - a.totalRefs;
                });
            } else {
                chapterVerses.sort((a, b) => b.totalRefs - a.totalRefs);
            }

            // Get top ref links from chapter level (respect vote threshold)
            const topRefs = (chapter.refsArray || [])
                .filter(r => r.votes >= voteThreshold)
                .sort((a, b) => b.votes - a.votes)
                .slice(0, 15);

            // Build the selected arc UI if present
            let selectedArcUI = '';
            if (selectedArc && selectedArc.sourcePos.chapterIdx === chapter.index) {
                const sourceText = getVerseText(selectedArc.sourceRef) || 'No text available';
                const targetText = getVerseText(selectedArc.targetRef) || 'No text available';
                const sourceUrl = getBibleHubUrl(selectedArc.sourceRef);
                const targetUrl = getBibleHubUrl(selectedArc.targetRef);

                selectedArcUI = `
                    <div class="bg-blue-900/30 border border-blue-700 rounded-lg p-3 mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full" style="background-color: ${selectedArc.sourceColor}"></span>
                            <span class="text-xs font-semibold text-blue-300">Selected Cross-Reference</span>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <div class="flex items-center justify-between">
                                    <span class="text-green-400 text-sm font-medium">${selectedArc.sourceRef}</span>
                                    ${sourceUrl ? `<a href="${sourceUrl}" target="_blank" class="text-[10px] bg-gray-700/50 hover:bg-gray-600 text-gray-300 hover:text-white px-1.5 py-0.5 rounded transition-colors border border-gray-600/50">BibleHub</a>` : ''}
                                </div>
                                <p class="text-gray-300 text-xs mt-1 leading-relaxed">${sourceText}</p>
                            </div>
                            <div class="text-center">
                                <span class="text-gray-500 text-xs">‚Üì ${selectedArc.votes} votes ‚Üì</span>
                            </div>
                            <div>
                                <div class="flex items-center justify-between">
                                    <span class="text-blue-400 text-sm font-medium">${selectedArc.targetRef}</span>
                                    ${targetUrl ? `<a href="${targetUrl}" target="_blank" class="text-[10px] bg-gray-700/50 hover:bg-gray-600 text-gray-300 hover:text-white px-1.5 py-0.5 rounded transition-colors border border-gray-600/50">BibleHub</a>` : ''}
                                </div>
                                <p class="text-gray-300 text-xs mt-1 leading-relaxed">${targetText}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            const html = `
                <div class="space-y-3">
                    <div>
                        <h3 class="text-sm font-semibold text-blue-400">${chapter.book} ${chapter.chapter}</h3>
                        <p class="text-gray-400">${chapter.refCount} chapters linked, ${chapterVerses.length} verses with refs</p>
                    </div>

                    ${selectedArcUI}

                    ${chapterVerses.length > 0 ? `
                    <div>
                        <h4 class="text-xs font-semibold text-gray-400 uppercase mb-1">Verses (${chapterVerses.length})</h4>
                        <div class="space-y-1 max-h-80 overflow-y-auto">
                            ${chapterVerses.map(v => {
                                const isSelected = selectedArc && v.ref === selectedArc.sourceRef;
                                const bgClass = isSelected ? 'bg-blue-800/40 border-blue-600' : 'bg-gray-700 hover:bg-gray-600';
                                const borderClass = isSelected ? 'border' : '';

                                return `
                                <div class="${bgClass} ${borderClass} rounded text-xs cursor-pointer transition-colors"
                                     onclick="toggleVerse(this)">
                                    <div class="p-2 flex justify-between items-center">
                                        <div>
                                            <span class="text-blue-300 font-medium">${v.ref}</span>
                                            <span class="text-gray-400 ml-2">${v.outgoingCount} out / ${v.incomingCount} in</span>
                                            ${isSelected ? '<span class="ml-2 text-xs text-blue-400">‚óè Selected</span>' : ''}
                                        </div>
                                        <span class="text-gray-500">‚ñº</span>
                                    </div>
                                    <div class="hidden p-2 pt-0 border-t border-gray-600 mt-1">
                                        <p class="text-gray-200 leading-relaxed">${v.text}</p>
                                        ${v.outgoingCount > 0 ? `
                                        <div class="mt-2">
                                            <span class="text-xs text-gray-500">Outbound refs:</span>
                                            <div class="space-y-0.5 mt-1">
                                                ${v.topRefs.slice(0, 5).map(r => {
                                                    const isTargetSelected = selectedArc && r.to === selectedArc.targetRef;
                                                    const bgClass = isTargetSelected ? 'bg-blue-900/40 text-blue-300' : 'text-gray-400 hover:text-blue-300';
                                                    return `
                                                    <div class="${bgClass} cursor-pointer flex justify-between px-1 py-0.5 rounded"
                                                         onclick="event.stopPropagation(); showVerseDetail('${r.to}')">
                                                        <span>‚Üí ${r.to}</span>
                                                        <span class="text-gray-500">${r.votes}v</span>
                                                    </div>
                                                `}).join('')}
                                                ${v.topRefs.length > 5 ? `<div class="text-gray-500 text-xs">+${v.topRefs.length - 5} more</div>` : ''}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    ` : '<p class="text-gray-500 text-xs">No verses with cross-references</p>'}

                    ${topRefs.length > 0 ? `
                    <div>
                        <h4 class="text-xs font-semibold text-gray-400 uppercase mb-1">Top Linked Chapters</h4>
                        <div class="space-y-1 max-h-40 overflow-y-auto">
                            ${topRefs.map(ref => {
                                const targetCh = chapters.find(c => c.index === ref.toIndex);
                                if (!targetCh) return '';
                                return `
                                    <div class="bg-gray-700 rounded p-2 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-blue-300">${targetCh.book} ${targetCh.chapter}</span>
                                            <span class="text-gray-400">${ref.votes}v</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            panel.innerHTML = html;
        }

        window.toggleVerse = function(element) {
            const content = element.querySelector('div:last-child');
            const arrow = element.querySelector('.text-gray-500');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.textContent = '‚ñ≤';
            } else {
                content.classList.add('hidden');
                arrow.textContent = '‚ñº';
            }
        };

        window.showVerseDetail = function(ref) {
            const panel = document.getElementById('detail-content');

            // Show details FAB on mobile
            const detailsToggle = document.getElementById('details-toggle');
            if (detailsToggle) {
                detailsToggle.classList.remove('hidden');
                // Open details panel on mobile
                if (window.innerWidth <= 640) {
                    document.getElementById('details-panel').classList.add('open');
                    document.getElementById('drawer-overlay').classList.add('show');
                }
            }

            const text = verseTexts[ref] || 'Not found';
            const refs = (crossRefs[ref] || [])
                .filter(r => r.votes >= voteThreshold)
                .sort((a,b) => b.votes - a.votes);
            const bibleHubUrl = getBibleHubUrl(ref);

            panel.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <h3 class="text-sm font-semibold text-blue-400">${ref}</h3>
                            ${bibleHubUrl ? `<a href="${bibleHubUrl}" target="_blank" class="text-[10px] bg-gray-700/50 hover:bg-gray-600 text-gray-300 hover:text-white px-1.5 py-0.5 rounded transition-colors border border-gray-600/50">BibleHub</a>` : ''}
                        </div>
                        <button onclick="selectBook('${ref.split(' ')[0]}')" class="text-xs text-gray-400 hover:text-blue-300">
                            View chapter
                        </button>
                    </div>
                    <p class="text-gray-300 text-xs leading-relaxed">${text}</p>
                    ${refs.length > 0 ? `
                    <div>
                        <h4 class="text-xs font-semibold text-gray-400 uppercase mb-1">Cross-References (${refs.length})</h4>
                        <div class="space-y-1 max-h-60 overflow-y-auto">
                            ${refs.map(r => {
                                const rBibleHubUrl = getBibleHubUrl(r.to);
                                return `
                                <div class="bg-gray-700 rounded p-1.5 text-xs flex justify-between items-center cursor-pointer hover:bg-gray-600"
                                     onclick="showVerseDetail('${r.to}')">
                                    <div class="flex items-center gap-2">
                                        <span class="text-blue-300">‚Üí ${r.to}</span>
                                        ${rBibleHubUrl ? `<a href="${rBibleHubUrl}" target="_blank" class="text-[10px] bg-gray-700/50 hover:bg-gray-600 text-gray-300 hover:text-white px-1.5 py-0.5 rounded transition-colors border border-gray-600/50" onclick="event.stopPropagation()">Hub</a>` : ''}
                                    </div>
                                    <span class="text-gray-500 bg-gray-800 px-1.5 rounded">${r.votes}v</span>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    ` : '<p class="text-gray-500 text-xs">No cross-references above vote threshold</p>'}
                </div>
            `;
        };

        // Check hover over arcs
        function updateHover() {
            if (!window.layout || !window.layout.allArcs) return;

            const layout = window.layout;

            const maxDistance = 30; // Maximum distance to consider

            let bestArc = null;
            let minDistance = Infinity;

            for (const arc of layout.allArcs) {
                const dx = Math.abs(arc.x2 - arc.x1);
                if (dx < 5) continue; // Skip very short arcs

                // Pre-calculate curve parameters
                const midX = (arc.x1 + arc.x2) / 2;
                const curveHeight = Math.min(dx * 0.75, arc.height * 1.3);
                const ctrlY = arc.y - curveHeight;

                // Quick bounding box check
                const arcMaxDist = maxDistance + 20;
                const minX = Math.min(arc.x1, arc.x2) - arcMaxDist;
                const maxX = Math.max(arc.x1, arc.x2) + arcMaxDist;
                const minY = arc.y - curveHeight - arcMaxDist;
                const maxY = arc.y + arcMaxDist;

                if (mouseX < minX || mouseX > maxX || mouseY < minY || mouseY > maxY) continue;

                // Sample the arc
                const sampleCount = Math.min(Math.max(Math.floor(dx / 3), 30), 120);

                for (let t = 0; t <= 1; t += 1 / sampleCount) {
                    const t1 = (1 - t) * (1 - t);
                    const t2 = 2 * (1 - t) * t;
                    const t3 = t * t;

                    const curveX = t1 * arc.x1 + t2 * midX + t3 * arc.x2;
                    const curveY = t1 * arc.y + t2 * ctrlY + t3 * arc.y;

                    const dist = Math.sqrt(Math.pow(mouseX - curveX, 2) + Math.pow(mouseY - curveY, 2));

                    if (dist < minDistance) {
                        minDistance = dist;
                        bestArc = arc;
                    }

                    // Early exit if we found something very close
                    if (dist < 5) break;
                }
            }

            const newHoveredArc = (minDistance <= maxDistance) ? bestArc : null;

            if (newHoveredArc !== hoveredArc) {
                hoveredArc = newHoveredArc;
                render();

                if (hoveredArc) {
                    const tooltip = document.getElementById('tooltip');
                    tooltip.style.left = mouseX + 'px';
                    tooltip.style.top = (mouseY - 55) + 'px';

                    tooltip.innerHTML = `
                        <div class="flex items-center gap-1 mb-1">
                            <span class="w-2 h-2 rounded-full" style="background-color: ${hoveredArc.sourceColor}"></span>
                            <strong>${hoveredArc.sourceTheme.name}</strong>
                        </div>
                        <div class="text-green-400">${hoveredArc.sourceRef}</div>
                        <div class="text-center text-gray-400 text-xs">‚Üì ${hoveredArc.votes} votes ‚Üì</div>
                        <div class="text-blue-400">${hoveredArc.targetRef}</div>
                    `;
                    tooltip.classList.remove('hidden');
                } else {
                    document.getElementById('tooltip').classList.add('hidden');
                }
            }
        }

        // Mobile drawer functions
        function setupMobileDrawers() {
            const menuToggle = document.getElementById('menu-toggle');
            const sidebarClose = document.getElementById('sidebar-close');
            const detailsToggle = document.getElementById('details-toggle');
            const detailsClose = document.getElementById('details-close');
            const overlay = document.getElementById('drawer-overlay');
            const sidebar = document.getElementById('sidebar');
            const detailsPanel = document.getElementById('details-panel');

            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                    overlay.classList.toggle('show');
                });
            }

            if (sidebarClose) {
                sidebarClose.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('show');
                });
            }

            if (detailsToggle) {
                detailsToggle.addEventListener('click', () => {
                    detailsPanel.classList.toggle('open');
                    overlay.classList.toggle('show');
                });
            }

            if (detailsClose) {
                detailsClose.addEventListener('click', () => {
                    detailsPanel.classList.remove('open');
                    overlay.classList.remove('show');
                });
            }

            if (overlay) {
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                    detailsPanel.classList.remove('open');
                    overlay.classList.remove('show');
                });
            }
        }

        // Help modal toggle
        window.toggleHelp = function() {
            const modal = document.getElementById('help-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        };

        // Arc navigation functions
        function navigateArc(direction) {
            if (visibleArcsForNavigation.length === 0) return;

            if (direction === 'next') {
                currentArcIndex = (currentArcIndex + 1) % visibleArcsForNavigation.length;
            } else if (direction === 'prev') {
                currentArcIndex = (currentArcIndex - 1 + visibleArcsForNavigation.length) % visibleArcsForNavigation.length;
            }

            const arc = visibleArcsForNavigation[currentArcIndex];
            currentArcId = arc.id;

            // Show tooltip with the arc data we have
            const tooltip = document.getElementById('tooltip');
            tooltip.style.left = (arc.x1 + arc.x2) / 2 - 100 + 'px';
            tooltip.style.top = (arc.y1 + arc.y2) / 2 - 60 + 'px';

            tooltip.innerHTML = `
                <div class="flex items-center gap-1 mb-1">
                    <span class="w-2 h-2 rounded-full" style="background-color: ${arc.sourceColor}"></span>
                    <strong>${arc.sourceTheme.name}</strong>
                </div>
                <div class="text-green-400">${arc.sourceRef}</div>
                <div class="text-center text-gray-400 text-xs">‚Üì ${arc.votes} votes ‚Üì</div>
                <div class="text-blue-400">${arc.targetRef}</div>
            `;
            tooltip.classList.remove('hidden');

            // Scroll to view the arc if needed
            scrollToArc(arc);

            // Set selectedArc for persistent selection (renders use this)
            selectedArc = arc;

            // Also focus on the source chapter for the details panel
            // The chapters array should be available globally from buildStructure
            if (arc.sourcePos && arc.sourcePos.chapterIdx >= 0) {
                const allChapters = chapters || window.chapters || [];
                if (arc.sourcePos.chapterIdx < allChapters.length) {
                    currentChapterView = allChapters[arc.sourcePos.chapterIdx];
                    showDetails(currentChapterView);
                    render();
                    return;
                }
            }

            render();

            // After render, update selectedArc from the new allArcs using the ID
            const newAllArcs = window.layout?.allArcs || [];
            selectedArc = newAllArcs.find(a => a.id === currentArcId) || null;
        }

        function scrollToArc(arc, margin = { left: 15, right: 15 }) {
            const centerPoint = (arc.x1 + arc.x2) / 2;
            const visibleWidth = width - margin.left - margin.right;

            // Try to access chapters through the global scope or from render context
            let allChapters = window.chapters;
            if (!allChapters) {
                // Fallback: approximate using the arc's chapter indices
                const chapterStep = visibleWidth / 1189; // total chapters
                const chapterAtCenter = Math.round((centerPoint - margin.left) / chapterStep);
                const targetScrollLeft = Math.max(0, chapterAtCenter * chapterStep - visibleWidth / 2);

                const vizContainer = document.getElementById('viz-container');
                if (vizContainer) {
                    vizContainer.scrollLeft = targetScrollLeft;
                }
                return;
            }

            const chapterStep = visibleWidth / allChapters.length;
            const chapterAtCenter = Math.round((centerPoint - margin.left) / chapterStep);
            const targetScrollLeft = Math.max(0, chapterAtCenter * chapterStep - visibleWidth / 2);

            const vizContainer = document.getElementById('viz-container');
            if (vizContainer) {
                vizContainer.scrollLeft = targetScrollLeft;
            }
        }

        function setupArcNavigation() {
            const leftBtn = document.getElementById('nav-left-arc');
            const rightBtn = document.getElementById('nav-right-arc');

            function updateNavButtonsVisibility() {
                const hasArcs = visibleArcsForNavigation.length > 0;
                if (hasArcs) {
                    leftBtn.classList.remove('hidden');
                    rightBtn.classList.remove('hidden');
                } else {
                    leftBtn.classList.add('hidden');
                    rightBtn.classList.add('hidden');
                }
            }

            if (leftBtn) {
                leftBtn.addEventListener('click', () => navigateArc('prev'));
            }
            if (rightBtn) {
                rightBtn.addEventListener('click', () => navigateArc('next'));
            }

            // Keyboard navigation (left/right arrows)
            document.addEventListener('keydown', (e) => {
                // Only navigate if not in an input field
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateArc(e.key === 'ArrowLeft' ? 'prev' : 'next');
                }
            });

            const originalRender = window.render;
            window.render = function() {
                originalRender.apply(this, arguments);
                updateNavButtonsVisibility();
            };
        }

        window.onload = async function() {
            await init();
            setupMobileDrawers();
            setupArcNavigation();
        };

            // Animation loop for hover effects
            function animate() {
                updateHover();
                requestAnimationFrame(animate);
            }
            animate();
        </script>
    </body>
</html>
